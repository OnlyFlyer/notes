<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div id="root" style="background: red;width: 0px;"></div>
</body>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script>
  const container = document.getElementById('root');
  let nextUnitOfWork = null;
  let wipRoot = null;

  const TEXT_ELEMENT_TYPE = 'TEXT_ELEMENT';

  function createTextElement(text) {
    return {
      type: TEXT_ELEMENT_TYPE,
      props: {
        nodeValue: text,
        children: [],
      }
    }
  }

  function createElement(type, props = {}, ...children) {
    return {
      type,
      props: {
        ...props,
        children: children.map((child) => {
          if (typeof child === 'object') return child;
          return createTextElement(child);
        }),
      }
    }
  }

  function render(element, container) {
    wipRoot = {
      dom: container,
      props: {
        children: [element],
      }
    }
    nextUnitOfWork = wipRoot;
    // return wipRoot;
  };

  function commitWork(fiber) {
    if (!fiber) return;
    if (fiber.dom && fiber.parent && fiber.parent.dom) {
      const domFarent = fiber.parent.dom;
      domFarent.appendChild(fiber.dom);
    }
    commitWork(fiber.child);
    commitWork(fiber.sibling);
  }

  function commitRoot() {
    commitWork(wipRoot);
    wipRoot = null;
  }

  function createDom(fiber) {
    const dom = fiber.type === TEXT_ELEMENT_TYPE
      ? document.createTextNode("")
      : document.createElement(fiber.type);
    Object.keys(fiber.type)
      .filter(key => key !== 'children')
      .forEach((name) => {
        dom[name] = fiber.props[name];
      });
    return dom;
  }
  

  function workLoop(deadline) {
    let shouldYield = false;
    while (nextUnitOfWork && !shouldYield) {
      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
      shouldYield = deadline.timeRemaining() < 1;
    }
    if (nextUnitOfWork && wipRoot) {
      commitRoot();
    }
    requestIdleCallback(workLoop);
  }
  requestIdleCallback(workLoop);
  
  function performUnitOfWork(fiber) {
    // 增加 dom 节点，还需要将子节点加到父节点上
    if (!fiber.dom) {
      fiber.dom = createDom(fiber);
    }
    // if (fiber.parent) {
    //   fiber.parent.dom.appendChild(fiber.dom);
    // }
    // 创建一个新的 fiber
    const elements = fiber.props.children;
    let index = 0;
    let prevSibling = null;
    while (index < elements.length) {
      const element = elements[index];
      const newFiber = {
        type: element.type,
        props: element.props,
        parent: fiber,
        dom: null,
      }

      if (index === 0) {
        fiber.child = newFiber;
      } else {
        prevSibling.sibling = newFiber;
      }
      prevSibling = newFiber;
      index++;
    }

    // 返回下一个工作单元
    if (fiber.child) {
      return fiber.child;
    }
    let nextFiber = fiber;
    while (nextFiber) {
      if (nextFiber.sibling) {
        return nextFiber.sibling;
      }
      nextFiber = nextFiber.parent;
    }
  }

  const Didact = {
    createElement,
    render,
  }

  const ele = Didact.createElement('h1', {title: 'foo'}, 'Hello', Didact.createElement('span', {title: 'hehe'}, 'haha'));
  Didact.render(ele, document.getElementById('root'));
  console.log(ele, '--ele')

  // function animationWidth() {
  //   const div = document.getElementById('root');
  //   div.style.width = parseInt(div.style.width) + 1 + 'px';
  //   if (parseInt(div.style.width) < 200) {
  //     requestAnimationFrame(animationWidth);
  //   }
  // }
  // requestAnimationFrame(animationWidth);
</script>
</html>